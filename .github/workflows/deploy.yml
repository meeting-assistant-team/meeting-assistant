name: Deploy to Production Server

on:
  push:
    branches:
      - main  # Trigger khi push v√†o branch main
  workflow_dispatch:  # Cho ph√©p manual trigger t·ª´ GitHub UI

jobs:
  deploy:
    name: Deploy to Server via SSH
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Deploy and Restart Containers via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e

            # 1. Chu·∫©n b·ªã th∆∞ m·ª•c project
            cd ~
            
            # Ki·ªÉm tra v√† x·ª≠ l√Ω repository
            if [ -d "meeting-assistant" ]; then
              echo "Project folder exists. Checking remote configuration..."
              cd meeting-assistant
              
              # Backup .env n·∫øu t·ªìn t·∫°i
              if [ -f ".env" ]; then
                cp .env ~/.env.backup
                echo ".env backed up"
              fi
              
              # Ki·ªÉm tra remote URL
              CURRENT_REMOTE=$(git remote get-url origin 2>/dev/null || echo "")
              if [[ "$CURRENT_REMOTE" != *"x-access-token"* ]]; then
                echo "Remote URL kh√¥ng c√≥ token, ƒëang fix..."
                cd ~
                rm -rf meeting-assistant
                git clone https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }} meeting-assistant
                cd meeting-assistant
                
                # Restore .env n·∫øu c√≥
                if [ -f ~/.env.backup ]; then
                  cp ~/.env.backup .env
                  echo ".env restored"
                fi
              else
                echo "Remote URL ƒë√£ c√≥ token authentication"
              fi
            else
              echo "Project folder not found. Cloning..."
              git clone https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }} meeting-assistant
              cd meeting-assistant
            fi

            # 2. ƒê·∫£m b·∫£o remote URL lu√¥n c√≥ token
            echo "Updating Git remote with authentication..."
            git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}

            # 3. C·∫≠p nh·∫≠t code m·ªõi nh·∫•t (ƒë·∫£m b·∫£o pull ƒë∆∞·ª£c code m·ªõi)
            echo "Fetching latest code..."
            git fetch --all
            git reset --hard origin/main
            git pull origin main
            
            # Hi·ªÉn th·ªã commit hi·ªán t·∫°i ƒë·ªÉ verify
            echo "Current commit:"
            git log -1 --oneline

            # 3. T·∫°o l·∫°i file .env (ghi ƒë√® m·ªói l·∫ßn deploy ƒë·ªÉ ƒë·∫£m b·∫£o ƒë·ªìng b·ªô secrets)
            echo "Recreating .env file..."
            cat > .env << EOF
            # Server Configuration
            APP_ENV=production
            APP_PORT=8080
            APP_HOST=0.0.0.0

            # Database Configuration
            DB_HOST=postgres
            DB_PORT=5432
            DB_USER=postgres
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            DB_NAME=meeting_assistant
            DB_SSLMODE=disable

            # Redis Configuration
            REDIS_HOST=redis
            REDIS_PORT=6379
            REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}
            REDIS_DB=0

            # JWT Configuration
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            JWT_ACCESS_TOKEN_EXPIRE=15m
            JWT_REFRESH_TOKEN_EXPIRE=7d

            # Google OAuth Configuration
            GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
            GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}
            GOOGLE_REDIRECT_URL=${{ secrets.GOOGLE_REDIRECT_URL }}

            # CORS Configuration
            CORS_ALLOWED_ORIGINS=${{ secrets.CORS_ALLOWED_ORIGINS }}
            EOF

            # 4. X√°c ƒë·ªãnh l·ªánh docker compose (h·ªó tr·ª£ c·∫£ version c≈© v√† m·ªõi)
            if command -v docker-compose &> /dev/null; then
              DOCKER_COMPOSE="docker-compose"
              echo "‚úÖ Using docker-compose (standalone)"
            elif docker compose version &> /dev/null; then
              DOCKER_COMPOSE="docker compose"
              echo "‚úÖ Using docker compose (plugin)"
            else
              echo "‚ùå Error: Neither docker-compose nor docker compose found!"
              exit 1
            fi

            # 5. D·ª´ng v√† x√≥a containers c≈©
            echo "üõë Stopping and removing old containers..."
            $DOCKER_COMPOSE -f docker-compose.prod.yml down

            # 6. X√≥a image c≈© c·ªßa app ƒë·ªÉ force rebuild
            echo "üóëÔ∏è  Removing old app images..."
            docker rmi meeting-assistant-app-prod 2>/dev/null || true
            docker images | grep meeting-assistant | awk '{print $3}' | xargs docker rmi -f 2>/dev/null || true

            # 7. X√¢y d·ª±ng l·∫°i image m·ªõi (kh√¥ng d√πng cache)
            echo "üî® Building new images without cache..."
            $DOCKER_COMPOSE -f docker-compose.prod.yml build --no-cache --pull app

            # 8. Ch·∫°y containers m·ªõi
            echo "üöÄ Starting new containers..."
            $DOCKER_COMPOSE -f docker-compose.prod.yml up -d --remove-orphans

            # 9. D·ªçn d·∫πp images v√† containers kh√¥ng d√πng
            echo "üßπ Cleaning up unused images..."
            docker image prune -af
            docker container prune -f

      - name: Health Check
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "‚è≥ Waiting for services to start..."
            sleep 20
            echo "üè• Checking health endpoint..."
            curl -f http://localhost:8080/health || (echo "‚ùå Health check failed!" && exit 1)
            echo "‚úÖ Health check passed!"

      - name: Notify Deployment Status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "‚úÖ Deployment successful!"
          else
            echo "‚ùå Deployment failed!"
          fi
