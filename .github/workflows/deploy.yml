name: Deploy to Production Server

on:
  push:
    branches:
      - main  # Trigger khi push vào branch main
  workflow_dispatch:  # Cho phép manual trigger từ GitHub UI

jobs:
  deploy:
    name: Deploy to Server via SSH
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Deploy and Restart Containers via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e

            # 1. Chuẩn bị thư mục project
            cd ~
            if [ ! -d "meeting-assistant" ]; then
              echo "Project folder not found. Cloning..."
              git clone https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }} meeting-assistant
            fi
            cd meeting-assistant

            # 2. Cập nhật code mới nhất (đảm bảo pull được code mới)
            echo "Fetching latest code..."
            git fetch --all
            git reset --hard origin/main
            git pull origin main
            
            # Hiển thị commit hiện tại để verify
            echo "Current commit:"
            git log -1 --oneline

            # 3. Tạo lại file .env (ghi đè mỗi lần deploy để đảm bảo đồng bộ secrets)
            echo "Recreating .env file..."
            cat > .env << EOF
            # Server Configuration
            APP_ENV=production
            APP_PORT=8080
            APP_HOST=0.0.0.0

            # Database Configuration
            DB_HOST=postgres
            DB_PORT=5432
            DB_USER=postgres
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            DB_NAME=meeting_assistant
            DB_SSLMODE=disable

            # Redis Configuration
            REDIS_HOST=redis
            REDIS_PORT=6379
            REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}
            REDIS_DB=0

            # JWT Configuration
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            JWT_ACCESS_TOKEN_EXPIRE=15m
            JWT_REFRESH_TOKEN_EXPIRE=7d

            # Google OAuth Configuration
            GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
            GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}
            GOOGLE_REDIRECT_URL=${{ secrets.GOOGLE_REDIRECT_URL }}

            # CORS Configuration
            CORS_ALLOWED_ORIGINS=${{ secrets.CORS_ALLOWED_ORIGINS }}
            EOF

            # 4. Dừng và xóa containers cũ
            echo "Stopping and removing old containers..."
            docker-compose -f docker-compose.prod.yml down

            # 5. Xóa image cũ của app để force rebuild
            echo "Removing old app images..."
            docker rmi meeting-assistant-app-prod 2>/dev/null || true
            docker images | grep meeting-assistant | awk '{print $3}' | xargs docker rmi -f 2>/dev/null || true

            # 6. Xây dựng lại image mới (không dùng cache)
            echo "Building new images without cache..."
            docker-compose -f docker-compose.prod.yml build --no-cache --pull app

            # 7. Chạy containers mới
            echo "Starting new containers..."
            docker-compose -f docker-compose.prod.yml up -d --remove-orphans

            # 8. Dọn dẹp images và containers không dùng
            echo "Cleaning up unused images..."
            docker image prune -af
            docker container prune -f

      - name: Health Check
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "Waiting for services to start..."
            sleep 20
            echo "Checking health endpoint..."
            curl -f http://localhost:8080/health || (echo "Health check failed!" && exit 1)

      - name: Notify Deployment Status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "✅ Deployment successful!"
          else
            echo "❌ Deployment failed!"
          fi
